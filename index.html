<!DOCTYPE html>
<html>
<head>
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }
        #canvas {
            position: fixed;
        }
        #toggleEdgeScrollingEnabled {
            position: fixed;
            top: 5px;
            left: 5px;
        }
        #togglePosLabelsEnabled {
            position: fixed;
            top: 30px;
            left: 5px;
        }
    </style>
    <script>
        var baseTileWidth = 126,
            baseTileHeight = 63,
            zoomFactor = 2,
            tileWidth = baseTileWidth * zoomFactor,
            tileHeight = baseTileHeight * zoomFactor,
            cameraX = 0,
            cameraY = 0,
            moveCameraStartX = -1,
            moveCameraStartY = -1,
            moveCamera = false,
            edgeScrollingEnabled = false,
            posLabelsEnabled = false,
            tile,
            block,
            ramp1,
            canvas;

        window.addEventListener("load", function() {
            canvas = document.getElementById("canvas");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            tile = new Image();
            tile.src = "tile@4x.png";
            tile.addEventListener("load", function() {
                requestAnimationFrame(draw);
            });

            block = new Image();
            block.src = "block@4x.png";
            block.addEventListener("load", function() {
                block.tileWidth = 504;
                block.tileHeight = 252;
                block.defWidth = 504;
                block.defHeight = 504;
                block.multiplierX = tileWidth / block.tileWidth;
                block.multiplierY = tileHeight / block.tileHeight;

                requestAnimationFrame(draw);
            });

            ramp1 = new Image();
            ramp1.src = "ramp1@4x.png";
            ramp1.addEventListener("load", function () {
                ramp1.tileWidth = 504;
                ramp1.tileHeight = 252;
                ramp1.defWidth = 504;
                ramp1.defHeight = 504;
                ramp1.multiplierX = tileWidth / ramp1.tileWidth;
                ramp1.multiplierY = tileHeight / ramp1.tileHeight;

                requestAnimationFrame(draw);
            });

            window.addEventListener("resize", function() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                requestAnimationFrame(draw);
            });

            document.getElementById("toggleEdgeScrollingEnabled").addEventListener("click", function() {
                edgeScrollingEnabled = !edgeScrollingEnabled;
                if (edgeDetected) {
                    moveCameraByEdge();
                }

                requestAnimationFrame(draw);
            }); 

            document.getElementById("togglePosLabelsEnabled").addEventListener("click", function() {
                posLabelsEnabled = !posLabelsEnabled;
                requestAnimationFrame(draw);
            });

            canvas.addEventListener("mousewheel", function(e) {
                if (e.deltaY < 0) {
                    if (zoomFactor >= 4) {
                        zoomFactor = 4;
                        return;
                    }

                    zoomFactor++;
                } else {
                    zoomFactor--;

                    if (zoomFactor < 1) {
                        if (zoomFactor <= 0.5) {
                            zoomFactor = 0.5;
                            return;
                        }

                        zoomFactor = 0.5;
                    }
                }
                
                // TODO: Zoom to middle of screen.
                tileWidth = baseTileWidth * zoomFactor;
                tileHeight = baseTileHeight * zoomFactor;
                block.multiplierX = tileWidth / block.tileWidth;
                block.multiplierY = tileHeight / block.tileHeight;
                ramp1.multiplierX = tileWidth / ramp1.tileWidth;
                ramp1.multiplierY = tileHeight / ramp1.tileHeight;
                requestAnimationFrame(draw);
            });

            canvas.addEventListener("mousedown", function(e) {
                if (e.which === 3) {
                    moveCamera = true;
                    moveCameraStartX = e.clientX - cameraX;
                    moveCameraStartY = e.clientY - cameraY;

                    e.preventDefault();
                    return false;
                }
            });

            var edgeDetected = false;
            var edgeSpeed = 5;
            var edgeDirectionX = 0;
            var edgeDirectionY = 0;
            canvas.addEventListener("mousemove", function(e) {
                if (moveCamera) {
                    cameraX = e.clientX - moveCameraStartX;
                    cameraY = e.clientY - moveCameraStartY;
                    
                    requestAnimationFrame(draw);
                } else {
                    var leftEdge = e.clientX < 10;
                    var rightEdge = e.clientX > canvas.width - 10;
                    var topEdge = e.clientY < 10;
                    var bottomEdge = e.clientY > canvas.height - 10;

                    if (leftEdge || rightEdge || topEdge || bottomEdge) {
                        edgeDirectionX = leftEdge ? edgeSpeed : (rightEdge ? -edgeSpeed : 0);
                        edgeDirectionY = topEdge ? (edgeSpeed / 2) : (bottomEdge ? -(edgeSpeed / 2) : 0);

                        if (!edgeDetected) {
                            edgeDetected = true;
                            moveCameraByEdge();
                        }
                    } else {
                        edgeDetected = false;
                    }
                }
            });


            function moveCameraByEdge() {
                if (!edgeDetected || !edgeScrollingEnabled) {
                    return;
                }

                cameraX += edgeDirectionX * zoomFactor;
                cameraY += edgeDirectionY * zoomFactor;
                setTimeout(function() {
                    requestAnimationFrame(draw);
                    moveCameraByEdge(); },
                    20);
            }

            canvas.addEventListener("mouseup", function(e) {
                if (e.which === 3) {
                    moveCamera = false;
                    moveCameraStartX = -1;
                    moveCameraStartY = -1;
                    e.preventDefault();
                    return false;
                }
            });

            canvas.addEventListener("contextmenu", function(e) {
                e.preventDefault();
                return false;
            })
        });

        function draw() {
            var context = canvas.getContext("2d");
            context.clearRect(0, 0, canvas.width, canvas.height);

            var offsetX = cameraX + canvas.width / 2,
                offsetY = cameraY + canvas.height / 2;

            var width = 15;
            var height = 10;
            for (var y = -height; y < height; y++) {
                for (var x = width; x > -width; x--) {
                    var tx = offsetX + (((tileWidth - 1) / 2) * x) + (((tileWidth - 1) / 2) * y) + 0.5;
                    var ty = offsetY - (((tileHeight - 1) / 2) * x) + (((tileHeight - 1) / 2) * y) + 0.5;
                    if (tx < -tileWidth
                        || ty < -tileHeight
                        || tx > canvas.width + tileWidth
                        || ty > canvas.height + (tileHeight * 2)) {
                        continue;
                    }

                    context.drawImage(
                        tile,
                        0,
                        0,
                        tile.width,
                        tile.height,
                        tx - (tileWidth / 2),
                        ty - (tileHeight / 2),
                        tileWidth,
                        tileHeight
                    );

                    if ((y == 0 && (x == 0 || x == 1)) || (y == 1 && (x == 2))) {
                        context.drawImage(
                            block,
                            0,
                            0,
                            block.defWidth,
                            block.defHeight,
                            tx - (tileWidth / 2),
                            ty - (tileHeight / 2) - ((block.defHeight * block.multiplierY) - tileHeight),
                            block.defWidth * block.multiplierX,
                            block.defHeight * block.multiplierY
                        );
                    } else if ((y == 0 && (x == -1 || x == 2)) || (y == 1 && (x == 0 || x == 1))) {
                        context.drawImage(
                            ramp1,
                            0,
                            0,
                            ramp1.defWidth,
                            ramp1.defHeight,
                            tx - (tileWidth / 2),
                            ty - (tileHeight / 2) - ((ramp1.defHeight * ramp1.multiplierY) - tileHeight),
                            ramp1.defWidth * ramp1.multiplierX,
                            ramp1.defHeight * ramp1.multiplierY
                        );
                    }

                    if (posLabelsEnabled) {
                        var debugText = x + "," + y;
                        var color = "white";
                        if (y === 0) {
                            color = "red";
                        } else if (x === 0) {
                            color = "green";
                        }
                        context.fillStyle = color;
                        context.textBaseline = "middle";
                        var size = context.measureText(debugText);
                        context.fillText(debugText, tx - (size.width / 2), ty);
                    }
                }

                if (edgeScrollingEnabled) {
                    context.beginPath();
                    context.strokeStyle = "red";
                    context.lineWidth = 10;
                    context.rect(0, 0, canvas.width, canvas.height);
                    context.stroke();
                }
            }
        }
    </script>
</head>
<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <button id="toggleEdgeScrollingEnabled">Toggle edge scrolling</button>
    <button id="togglePosLabelsEnabled">Toggle position labels</button>
</body>
</html>