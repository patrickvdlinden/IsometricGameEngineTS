<!DOCTYPE html>
<html>
<head>
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }
        canvas {
            position: fixed;
        }
        #toggleEdgeScrollingEnabled {
            position: fixed;
            top: 5px;
            left: 5px;
        }
        #togglePosLabelsEnabled {
            position: fixed;
            top: 30px;
            left: 5px;
        }
    </style>
    <script>
        var baseTileWidth = 126,
            baseTileHeight = 63,
            zoomFactor = 1,
            tileWidth = baseTileWidth * zoomFactor,
            tileHeight = baseTileHeight * zoomFactor,
            cameraX = 0,
            cameraY = 0,
            moveCameraStartX = -1,
            moveCameraStartY = -1,
            moveCamera = false,
            edgeScrollingEnabled = false,
            posLabelsEnabled = false,
            groundLayerCanvas,
            objectLayerCanvas,
            uiLayerCanvas;

        function TileDefinition (src, srcX, srcY, srcWidth, srcHeight, tw, th, yOffsetDir, isAnimated) {
            this.source = src;
            this.tileWidth = tw;
            this.tileHeight = th;
            this.sourceX = srcX;
            this.sourceY = srcY;
            this.sourceWidth = srcWidth;
            this.sourceHeight = srcHeight;
			this.yOffsetDirection = yOffsetDir || 0;
            this.isAnimated = isAnimated || false;
            this.current = this;
        };

        var tile = new Image();
            tile.src = "tile@4x.png";

        var tiles = new Image();
            tiles.src = "tiles.png";

        var block = new Image();
            block.src = "block@4x.png";
            block.addEventListener("load", function () {
                block.tileWidth = 504;
                block.tileHeight = 252;
                block.defWidth = 504;
                block.defHeight = 504;
                block.multiplierX = tileWidth / block.tileWidth;
                block.multiplierY = tileHeight / block.tileHeight;
            });

        var blocks = new Image();
            blocks.src = "blocks.png";

        var ramp1 = new Image();
            ramp1.src = "ramp1@4x.png";
            ramp1.addEventListener("load", function () {
                ramp1.tileWidth = 504;
                ramp1.tileHeight = 252;
                ramp1.defWidth = 504;
                ramp1.defHeight = 504;
                ramp1.multiplierX = tileWidth / ramp1.tileWidth;
                ramp1.multiplierY = tileHeight / ramp1.tileHeight;
            });

        var tileDefinitions = {
            default: new TileDefinition(tiles, 0, 0, 504, 262, 504, 252), 
            ground: new TileDefinition(tiles, 504, 0, 504, 262, 504, 252),
            water: new TileDefinition(tiles, 1008, 0, 504, 262, 504, 252, 0, true),
            lava: new TileDefinition(tiles, 1512, 0, 504, 252, 504, 252),
            block: new TileDefinition(blocks, 0, 0, 504, 504, 504, 252),
            rampEast: new TileDefinition(blocks, 504, 0, 504, 504, 504, 252),
            rampSouth: new TileDefinition(blocks, 504, 504, 504, 504, 504, 252),
            rampWest: new TileDefinition(blocks, 504, 1008, 504, 504, 504, 252),
            rampNorth: new TileDefinition(blocks, 504, 1512, 504, 504, 504, 252),
        };

        var groundLayer = [
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, null, null, null, null, null, null],
            [null, null, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, null, null, null],
            [null, null, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, null, null],
            [null, null, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.water, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, null, null, null],
            [null, null, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, tileDefinitions.ground, null, null, null, null, null, null],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
        ];

        var objectLayer = [
            [tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, null, null, null, null],
            [tileDefinitions.block, tileDefinitions.block, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, null],
            [tileDefinitions.block, tileDefinitions.rampEast, null, null, null, null, null, null, null, null, null, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.rampSouth, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block],
            [tileDefinitions.block, tileDefinitions.rampEast, null, null, null, null, null, null, null, null, null, null, null, null, tileDefinitions.rampSouth, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block],
            [tileDefinitions.block, tileDefinitions.rampEast, null, null, null, null, null, null, null, null, null, null, null, null, null, tileDefinitions.rampWest, tileDefinitions.block],
            [tileDefinitions.block, tileDefinitions.rampEast, null, null, null, null, null, null, null, null, null, null, null, null, tileDefinitions.rampNorth, tileDefinitions.block, tileDefinitions.block],
            [tileDefinitions.block, tileDefinitions.rampEast, null, null, null, null, null, null, null, null, null, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block],
            [tileDefinitions.block, tileDefinitions.block, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.rampNorth, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, null],
            [tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, tileDefinitions.block, null, null, null, null],
        ];

        window.addEventListener("load", function() {
            groundLayerCanvas = document.getElementById("groundLayerCanvas");
            groundLayerCanvas.width = window.innerWidth;
            groundLayerCanvas.height = window.innerHeight;

            objectLayerCanvas = document.getElementById("objectLayerCanvas");
            objectLayerCanvas.width = window.innerWidth;
            objectLayerCanvas.height = window.innerHeight;

            uiLayerCanvas = document.getElementById("uiLayerCanvas");
            uiLayerCanvas.width = window.innerWidth;
            uiLayerCanvas.height = window.innerHeight;

            var cameraPos = translateXY(groundLayer.length / 2, groundLayer[0].length / 3);
            cameraX += cameraPos.x;
            cameraY -= cameraPos.y;

            window.addEventListener("resize", function() {
                groundLayerCanvas.width = window.innerWidth;
                groundLayerCanvas.height = window.innerHeight;
                objectLayerCanvas.width = window.innerWidth;
                objectLayerCanvas.height = window.innerHeight;
                uiLayerCanvas.width = window.innerWidth;
                uiLayerCanvas.height = window.innerHeight;
            });

            document.getElementById("toggleEdgeScrollingEnabled").addEventListener("click", function() {
                edgeScrollingEnabled = !edgeScrollingEnabled;
                if (edgeDetected) {
                    moveCameraByEdge();
                }
            }); 

            document.getElementById("togglePosLabelsEnabled").addEventListener("click", function() {
                posLabelsEnabled = !posLabelsEnabled;
            });

            window.addEventListener("wheel", function(e) {
                if (e.deltaY < 0) {
                    if (zoomFactor >= 4) {
                        zoomFactor = 4;
                        return;
                    }

                    zoomFactor++;
                } else {
                    zoomFactor--;

                    if (zoomFactor < 1) {
                        if (zoomFactor <= 0.5) {
                            zoomFactor = 0.5;
                            return;
                        }

                        zoomFactor = 0.5;
                    }
                }
                
                // TODO: Zoom to middle of screen.
                tileWidth = baseTileWidth * zoomFactor;
                tileHeight = baseTileHeight * zoomFactor;
                block.multiplierX = tileWidth / block.tileWidth;
                block.multiplierY = tileHeight / block.tileHeight;
                ramp1.multiplierX = tileWidth / ramp1.tileWidth;
                ramp1.multiplierY = tileHeight / ramp1.tileHeight;
            });

            window.addEventListener("mousedown", function(e) {
                if (e.which === 3) {
                    moveCamera = true;
                    moveCameraStartX = e.clientX - cameraX;
                    moveCameraStartY = e.clientY - cameraY;

                    e.preventDefault();
                    return false;
                }
            });

            var edgeDetected = false;
            var edgeSpeed = 5;
            var edgeDirectionX = 0;
            var edgeDirectionY = 0;
            window.addEventListener("mousemove", function(e) {
                if (moveCamera) {
                    cameraX = e.clientX - moveCameraStartX;
                    cameraY = e.clientY - moveCameraStartY;
                } else {
                    var leftEdge = e.clientX < 10;
                    var rightEdge = e.clientX > groundLayerCanvas.width - 10;
                    var topEdge = e.clientY < 10;
                    var bottomEdge = e.clientY > groundLayerCanvas.height - 10;

                    if (leftEdge || rightEdge || topEdge || bottomEdge) {
                        edgeDirectionX = leftEdge ? edgeSpeed : (rightEdge ? -edgeSpeed : 0);
                        edgeDirectionY = topEdge ? (edgeSpeed / 2) : (bottomEdge ? -(edgeSpeed / 2) : 0);

                        if (!edgeDetected) {
                            edgeDetected = true;
                            moveCameraByEdge();
                        }
                    } else {
                        edgeDetected = false;
                    }
                }
            });

            function moveCameraByEdge() {
                if (!edgeDetected || !edgeScrollingEnabled) {
                    return;
                }

                cameraX += edgeDirectionX * zoomFactor;
                cameraY += edgeDirectionY * zoomFactor;
                setTimeout(function() {
                    moveCameraByEdge(); },
                    20);
            }

            window.addEventListener("mouseup", function(e) {
                if (e.which === 3) {
                    moveCamera = false;
                    moveCameraStartX = -1;
                    moveCameraStartY = -1;
                    e.preventDefault();
                    return false;
                }
            });

            window.addEventListener("contextmenu", function(e) {
                e.preventDefault();
                return false;
            });

            var ticks = 0;
            var waterAnimationIndex = 0;
            setInterval(function() {
                ticks++;
                if (ticks  >= 100) {
                    ticks = 0;
                    waterAnimationIndex++;
                    if (waterAnimationIndex >= 4) {
                        waterAnimationIndex = 0;
                    }
                    tileDefinitions.water.current = new TileDefinition(tiles, 1008, waterAnimationIndex * 262, 504, 262, 504, 252, -1);
                }

                requestAnimationFrame(draw);
            }, 10);
        });

        function translateXY(x, y) {
            return {
                x: -(((tileWidth - 1) / 2) * y) + (((tileWidth - 1) / 2) * x) + 0.5,
                y: (((tileHeight - 1) / 2) * y) + (((tileHeight - 1) / 2) * x) + 0.5
            };
        }

        function translateOffsetXY(x, y) {
            var offsetX = cameraX + (window.innerWidth / 2),
                offsetY = cameraY + (window.innerHeight / 2);

            var tx = offsetX - (((tileWidth - 1) / 2) * y) + (((tileWidth - 1) / 2) * x) + 0.5,
                ty = offsetY + (((tileHeight - 1) / 2) * y) + (((tileHeight - 1) / 2) * x) + 0.5;

            return { x: tx, y: ty };
        }

        function draw() {
            var groundLayerContext = groundLayerCanvas.getContext("2d");
            groundLayerContext.clearRect(0, 0, groundLayerCanvas.width, groundLayerCanvas.height);

            var objectLayerContext = objectLayerCanvas.getContext("2d");
            objectLayerContext.clearRect(0, 0, objectLayerCanvas.width, objectLayerCanvas.height);

            var uiLayerContext = uiLayerCanvas.getContext("2d");
            uiLayerContext.clearRect(0, 0, uiLayerCanvas.width, uiLayerCanvas.height);

            var width = groundLayer[0].length;
            var height = groundLayer.length;

            for (var y = 0; y < height; y++) {
                for (var x = 0; x < width; x++) {
                    var absPosition = translateOffsetXY(x, y);
                    if (absPosition.x < -tileWidth
                        || absPosition.y < -tileHeight
                        || absPosition.x > groundLayerCanvas.width + tileWidth
                        || absPosition.y > groundLayerCanvas.height + (tileHeight * 2)) {
                        continue;
                    }

                    var tile = tileDefinitions.default;
                    if (groundLayer[y] && groundLayer[y][x]) {
                        tile = groundLayer[y][x];
                    }
                    var multiplierX = tileWidth / tile.tileWidth;
                    var multiplierY = tileHeight / tile.tileHeight;
                    if (tile.isAnimated) {
                        tile = tile.current;
                    }
                    
                    var yOffset = 0;
                    if (tile.yOffsetDirection > 0) {
                        yOffset = ((tile.sourceHeight * multiplierY) - tileHeight);
                    }
                    
                    groundLayerContext.drawImage(
                        tiles,
                        tile.sourceX,
                        tile.sourceY,
                        tile.sourceWidth,
                        tile.sourceHeight,
                        absPosition.x - (tileWidth / 2),
                        absPosition.y - (tileHeight / 2) - yOffset,
                        tile.sourceWidth * multiplierX,
                        tile.sourceHeight * multiplierY);

                    if (objectLayer[y] && objectLayer[y][x]) {
                        var object = objectLayer[y][x];
                        var multiplierX = tileWidth / object.tileWidth;
                        var multiplierY = tileHeight / object.tileHeight;
                        objectLayerContext.drawImage(
                            blocks,
                            object.sourceX,
                            object.sourceY,
                            object.sourceWidth,
                            object.sourceHeight,
                            absPosition.x - (tileWidth / 2),
                            absPosition.y - (tileHeight / 2) - ((object.sourceHeight * multiplierY) - tileHeight),
                            object.sourceWidth * multiplierX,
                            object.sourceHeight * multiplierY);
                    }

                    if (posLabelsEnabled) {
                        var debugText = x + "," + y +" ("+ Math.round(absPosition.x) +","+ Math.round(absPosition.y) +")";
                        var color = "white";
                        if (y === 0) {
                            color = "red";
                        } else if (x === 0) {
                            color = "green";
                        }
                        uiLayerContext.fillStyle = color;
                        uiLayerContext.textBaseline = "middle";
                        var size = uiLayerContext.measureText(debugText);
                        uiLayerContext.fillText(debugText, absPosition.x - (size.width / 2), absPosition.y);
                    }
                }

                uiLayerContext.beginPath();
                uiLayerContext.strokeStyle = "red";
                uiLayerContext.lineWidth = 10;

                if (edgeScrollingEnabled) {
                    uiLayerContext.rect(
                        uiLayerContext.lineWidth / 2,
                        uiLayerContext.lineWidth / 2,
                        groundLayerCanvas.width - (uiLayerContext.lineWidth),
                        groundLayerCanvas.height - (uiLayerContext.lineWidth));
                    uiLayerContext.stroke();
                }

                uiLayerContext.lineWidth = 5;

                uiLayerContext.moveTo(window.innerWidth / 2, 0);
                uiLayerContext.lineTo(window.innerWidth / 2, window.innerHeight);
                uiLayerContext.stroke();

                uiLayerContext.moveTo(0, window.innerHeight / 2);
                uiLayerContext.lineTo(window.innerWidth , window.innerHeight / 2);
                uiLayerContext.stroke();
            }
        }
    </script>
</head>
<body>
    <canvas id="groundLayerCanvas" width="800" height="600"></canvas>
    <canvas id="objectLayerCanvas" width="800" height="600"></canvas>
    <canvas id="uiLayerCanvas" width="800" height="600"></canvas>
    <button id="toggleEdgeScrollingEnabled">Toggle edge scrolling</button>
    <button id="togglePosLabelsEnabled">Toggle position labels</button>
</body>
</html>
